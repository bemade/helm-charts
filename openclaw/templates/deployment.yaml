apiVersion: apps/v1
kind: Deployment
metadata:
  name: openclaw
  namespace: {{ .Release.Namespace }}
  labels:
    app: openclaw
spec:
  replicas: 1
  selector:
    matchLabels:
      app: openclaw
  template:
    metadata:
      labels:
        app: openclaw
    spec:
      containers:
        - name: openclaw
          image: "{{ .Values.openclaw.image.repository }}:{{ .Values.openclaw.image.tag }}"
          imagePullPolicy: {{ .Values.openclaw.image.pullPolicy }}
          command: ["node", "/app/openclaw.mjs"]
          args: ["gateway", "--port", "{{ .Values.openclaw.port }}", "--host", "0.0.0.0"]
          resources:
            requests:
              cpu: {{ .Values.openclaw.resources.requests.cpu }}
              memory: {{ .Values.openclaw.resources.requests.memory }}
            limits:
              cpu: {{ .Values.openclaw.resources.limits.cpu }}
              memory: {{ .Values.openclaw.resources.limits.memory }}
          ports:
            - containerPort: {{ .Values.openclaw.port }}
              name: http
          env:
            # Anthropic API key
            {{- if .Values.openclaw.secrets.anthropicApiKey }}
            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: openclaw-secrets
                  key: anthropic-api-key
            {{- end }}
            # OpenAI API key (optional)
            {{- if .Values.openclaw.secrets.openaiApiKey }}
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: openclaw-secrets
                  key: openai-api-key
            {{- end }}
            # Gateway token
            {{- if .Values.openclaw.secrets.gatewayToken }}
            - name: OPENCLAW_GATEWAY_TOKEN
              valueFrom:
                secretKeyRef:
                  name: openclaw-secrets
                  key: gateway-token
            {{- end }}
          volumeMounts:
            - name: openclaw-data
              mountPath: /home/node/.openclaw
            - name: openclaw-config
              mountPath: /home/node/.openclaw/openclaw.json
              subPath: openclaw.json
          livenessProbe:
            httpGet:
              path: /health
              port: {{ .Values.openclaw.port }}
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: {{ .Values.openclaw.port }}
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: openclaw-config
          configMap:
            name: openclaw-config
        - name: openclaw-data
          {{- if .Values.openclaw.persistence.enabled }}
          persistentVolumeClaim:
            claimName: openclaw-data
          {{- else }}
          emptyDir: {}
          {{- end }}
