apiVersion: batch/v1
kind: Job
metadata:
  name: init-db-user-{{ .Release.Name }}-{{ .Values.odoo.production.hostname }}
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    spec:
      {{- if .Values.odoo.database.adminSecretNamespace }}
      serviceAccountName: {{ .Release.Name }}-db-jobs
      {{- end }}
      restartPolicy: OnFailure
      containers:
        - name: init-db-user
          image: postgres:16.1
          command: ["/bin/bash", "/scripts/init-db-user.sh"]
          env:
            - name: HOST
              value: {{ .Values.odoo.database.host | quote }}
            - name: PORT
              value: {{ .Values.odoo.database.port | quote }}
            - name: ADMIN_USER
              value: {{ .Values.odoo.database.adminUser | quote }}
            - name: ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  {{- if .Values.odoo.database.adminSecretNamespace }}
                  name: {{ .Release.Name }}-postgres-secret
                  {{- else }}
                  name: {{ .Values.odoo.database.adminSecretName }}
                  {{- end }}
                  key: {{ .Values.odoo.database.adminPasswordKey }}
            - name: NEW_USER
              value: {{ printf "%s-%s-%s" .Release.Namespace .Release.Name .Values.odoo.production.hostname | lower | replace "_" "-" | quote }}
            - name: NEW_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: credentials
                  key: password
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  {{- if .Values.odoo.database.adminSecretNamespace }}
                  name: {{ .Release.Name }}-postgres-secret
                  {{- else }}
                  name: {{ .Values.odoo.database.adminSecretName }}
                  {{- end }}
                  key: {{ .Values.odoo.database.adminPasswordKey }}
          volumeMounts:
            - name: init-db-script
              mountPath: /scripts
      volumes:
        - name: init-db-script
          configMap:
            name: init-db-script
